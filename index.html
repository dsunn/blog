<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Whatever blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.145.0">
    
    
    
      <meta name="robots" content="index, follow">
    
    

    
<link rel="stylesheet" href="/blog/ananke/css/main.min.d05fb5f317fcf33b3a52936399bdf6f47dc776516e1692e412ec7d76f4a5faa2.css" >




    

    
      

    

    
    
      <link href="/blog/index.xml" rel="alternate" type="application/rss+xml" title="Whatever blog" />
      <link href="/blog/index.xml" rel="feed" type="application/rss+xml" title="Whatever blog" />
      
    

    
      <link rel="canonical" href="https://dsunn.github.io/blog/">
    

    <meta property="og:url" content="https://dsunn.github.io/blog/">
  <meta property="og:site_name" content="Whatever blog">
  <meta property="og:title" content="Whatever blog">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="Whatever blog">
  <meta itemprop="datePublished" content="2025-03-22T14:18:21+08:00">
  <meta itemprop="dateModified" content="2025-03-22T14:18:21+08:00">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Whatever blog">

      
    
	
  </head><body class="ma0 avenir bg-near-white production">

    

  <header>
    <div class="pb3-m pb6-l bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/blog/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Whatever blog
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

      <div class="tc-l pv3 ph3 ph4-ns">
        <h1 class="f2 f-subheadline-l fw2 light-silver mb0 lh-title">
          Whatever blog
        </h1>
        
      </div>
    </div>
  </header>


    <main class="pb7" role="main">
      
  <article class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy mid-gray">
    
  </article>

  
  
  
  
  

  
    <div class="pa3 pa4-ns w-100 w-70-ns center">
      

      <section class="w-100 mw8">
        
        
          <div class="relative w-100 mb4">
            
<article class="bb b--black-10">
  <div class="db pv4 ph3 ph0-l no-underline dark-gray">
    <div class="flex flex-column flex-row-ns">
      
      <div class="blah w-100">
        <h1 class="f3 fw1 athelas mt0 lh-title">
          <a href="/blog/post/vyos/" class="color-inherit dim link">
            Vyos
            </a>
        </h1>
        <div class="f6 f5-l lh-copy nested-copy-line-height nested-links">
          <p>vyos的命令行界面是基于shell的，没有图形界面, 但是可以用tab自动补全.
本文的vyos命令是基于vyos的vyos-rolling-nightly-builds的1.5.x版本.</p>
<p>pve安装vyos:
下载nightly-build: <a href="https://github.com/vyos/vyos-nightly-build/releases">https://github.com/vyos/vyos-nightly-build/releases</a>
pve的虚拟机设置和安装(略), 建议内存2G, 磁盘10G或更大, 因为vyos可以运行容器, vyos用podman管理容器.</p>
<p>vm运行后, 用vyos:vyos登录. 用命令</p>
<pre tabindex="0"><code>install image
</code></pre><p>安装vyos.</p>
<p>设置ssh登录:</p>
<pre tabindex="0"><code>set service ssh port &#39;22&#39;
</code></pre><p>创建用户dave:</p>
<pre tabindex="0"><code>set system login user dave full-name dave
set system login user dave authentication plaintext-password &#39;your-password&#39;
</code></pre><p>建议ssh密钥登录:</p>
<pre tabindex="0"><code>set system login user dave authentication public-keys dave@laptop key &#39;your-public-key&#39;
set system login user dave authentication public-keys dave@laptop type &#39;ssh-rsa&#39;
</code></pre><p>禁用默认的vyos用户:</p>
<pre tabindex="0"><code>set system login user vyos disable
</code></pre><p>设置系统的hostname:</p>
<pre tabindex="0"><code>set system host-name &#39;vyos&#39;
</code></pre><p>设置时区:</p>
<pre tabindex="0"><code>set system time-zone &#39;Asia/Shanghai&#39;
</code></pre><p>设置ntp:</p>
        </div>
        <a href="/blog/post/vyos/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
      </div>
    </div>
  </div>
</article>

          </div>
        
          <div class="relative w-100 mb4">
            
<article class="bb b--black-10">
  <div class="db pv4 ph3 ph0-l no-underline dark-gray">
    <div class="flex flex-column flex-row-ns">
      
      <div class="blah w-100">
        <h1 class="f3 fw1 athelas mt0 lh-title">
          <a href="/blog/post/all_about_dns/" class="color-inherit dim link">
            All about dns
            </a>
        </h1>
        <div class="f6 f5-l lh-copy nested-copy-line-height nested-links">
          <p>谈谈我的dns在一些特殊的网络架构中的思路&hellip;
目的:</p>
<ul>
<li>走节点的连接, 其dns请求不发到国内的dns服务器</li>
<li>减少不必要的dns请求</li>
<li>尽量避免所谓的dns leak</li>
</ul>
<hr>
<p>我的内部网络:</p>
<p>主路由 ros, 旁路网关 clash on debain, mosdns server, 交换机, 及各种终端;
其中clash所在的debian, 网关为ros, 其他设备的网关为clash所在的debian;
内网到内网的通信基本上会经交换机转发抵达.</p>
<p>ros:</p>
<p>ros上开启dns服务, 上游为ISP的ipv4和ipv6服务器, 开启Allow Remote Requests, (这条开启是仅仅让mosdns访问的, 后面详解)
ros通过dhcp_server通知各终端把dns和网关都指向clash及clash_dns, 除clash自己.</p>
<p>clash:</p>
<p>clash开启dns服务(我用的fake_ip, 当然不用fake_ip也行, 不影响前述目的), clash_dns的唯一上游, 是mosdns; 同时, clash 的 fallback_dns关闭</p>
<p>mosdns:</p>
<p>mosdns按direct-list(即cn_sites)的域名进行分流, 命中该list的, 请求发到上游ros_dns, ros_dns会向它的上游, 也就是向各ISP_dns请求; 而没有命中该list的, 也就是走节点的, mosdns把请求发给上游8.8.8.8(建议dot/doh); mosdns同样不采用fallback_dns的策略.</p>
<p>我们来看一下数据包的路径: mosdns发给ros的请求, 因为都是内网设备, 将直接由交换机转发, 而不经过mosdns的网关, 即clash所在的debian; 而mosdns发给8.8.8.8(我是用dot)的请求, 会按网关要求, 发给clash所在的debian, debian会转发给clash, 由clash加密封装后, 按规则走指定的节点. 当然clash最后也是通过debian的网关, 即ros, 再发到节点.</p>
<p>各终端设备:</p>
<p>终端设备的dns, 是近观ros dhcp_server的通知, 设置为clash_dns, 而clash_dns_server, 我是设置为fake_ip模式, 当然也可以不设置为fake_ip模式, 后面我会说fake_ip模式的好处.</p>
        </div>
        <a href="/blog/post/all_about_dns/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
      </div>
    </div>
  </div>
</article>

          </div>
        
          <div class="relative w-100 mb4">
            
<article class="bb b--black-10">
  <div class="db pv4 ph3 ph0-l no-underline dark-gray">
    <div class="flex flex-column flex-row-ns">
      
      <div class="blah w-100">
        <h1 class="f3 fw1 athelas mt0 lh-title">
          <a href="/blog/post/mikrotik_cf_ddns/" class="color-inherit dim link">
            cloudflare ddns的routeros脚本
            </a>
        </h1>
        <div class="f6 f5-l lh-copy nested-copy-line-height nested-links">
          <p>在参考了j大佬的<a href="https://www.digs.eu.org/2024/01/04/ROS%20cloudflare%20DDNS%E7%9B%B8%E5%85%B3%E8%84%9A%E6%9C%AC/">博客</a>和这位作者的<a href="https://gist.githubusercontent.com/kolobus/18680f8fb01ce3003cb9a3f82c9d30e1/raw/cf8ecd84fc0e5dccb7298422c7d8c40410c345a3/cf-ddns.rsc">脚本</a>的脚本后, 魔改的.</p>
<p>适用在cloudflare上更新ipv4和ipv6的动态ip; 和原作者不同的是, 我的脚本是直接从ros接口上取相应ip, 其实我这脚本是放在ppp profile-on up-script中, 在拨号完成后执行一次, 而不是定时反复执行, 故相应修改了代码.</p>
<p>token, zone_id, record_id等请先行获取, 获取方法在前述j大佬博客中有所提及.</p>
<pre tabindex="0"><code># Cloudflare Dynamic DNS update script
# Required policy: read, write, test, policy
# Add this script to scheduler
# Install DigiCert root CA or disable check-certificate
# Modified from https://gist.github.com/kolobus/18680f8fb01ce3003cb9a3f82c9d30e1
# Configuration ---------------------------------------------------------------------

:local TOKEN &#34;&#34;

:local ZONEIDv6 &#34;&#34;
:local RECORDIDv6 &#34;&#34;
:local RECORDNAMEv6 &#34;&#34;
:local IP6NEW

:local ZONEIDv4 &#34;&#34;
:local RECORDIDv4 &#34;&#34;
:local RECORDNAMEv4 &#34;&#34;
:local IP4NEW

:local WANIF &#34;&#34;

#------------------------------------------------------------------------------------




:if ([/interface get $WANIF value-name=running]) do={

    # IPv6 check

    :local &#34;IP6NEW&#34; [/ipv6/address get [:pick [find dynamic global interface=$WANIF] 0 ] address]
    :set &#34;IP6NEW&#34; [:pick $&#34;IP6NEW&#34; 0 [:find $&#34;IP6NEW&#34; &#34;/&#34;]]

        :local url &#34;https://api.cloudflare.com/client/v4/zones/$ZONEIDv6/dns_records/$RECORDIDv6/&#34;

        :local cfapi [/tool fetch http-method=put mode=https url=$url check-certificate=no output=user as-value \
            http-header-field=&#34;Authorization: Bearer $TOKEN&#34; \
            http-data=&#34;{\&#34;type\&#34;:\&#34;AAAA\&#34;,\&#34;name\&#34;:\&#34;$RECORDNAMEv6\&#34;,\&#34;content\&#34;:\&#34;$IP6NEW\&#34;,\&#34;ttl\&#34;:120,\&#34;proxied\&#34;:false}&#34;]

        :log info &#34;CF-DDNS: $RECORDNAMEv6 is now $IP6NEW&#34;


   # IPv4 check

    :local ipaddr [/ip address get [/ip address find interface=$WANIF] address]
    :set IP4NEW [:pick $ipaddr 0 ([len $ipaddr] -3)]

        :local url &#34;https://api.cloudflare.com/client/v4/zones/$ZONEIDv4/dns_records/$RECORDIDv4/&#34;

        :local cfapi [/tool fetch http-method=put mode=https url=$url check-certificate=no output=user as-value \
            http-header-field=&#34;Authorization: Bearer $TOKEN&#34; \
            http-data=&#34;{\&#34;type\&#34;:\&#34;A\&#34;,\&#34;name\&#34;:\&#34;$RECORDNAMEv4\&#34;,\&#34;content\&#34;:\&#34;$IP4NEW\&#34;,\&#34;ttl\&#34;:120,\&#34;proxied\&#34;:false}&#34;]

        :log info &#34;CF-DDNS: $RECORDNAMEv4 is now $IP4NEW&#34;


} else={

    :log info &#34;CF-DDNS: $WANIF is not currently running, quitting&#34;

}
</code></pre>
        </div>
        <a href="/blog/post/mikrotik_cf_ddns/" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">read more</a>
      </div>
    </div>
  </div>
</article>

          </div>
        
      </section>

      
        <section class="w-100">
          <h1 class="f3">More</h1>
          
          
            <h2 class="f5 fw4 mb4 dib mr3">
              <a href="/blog/post/clash_nft/" class="link black dim">
                debian搭建clash的透明代理(Tproxy)(nftables转发)
              </a>
            </h2>
          
            <h2 class="f5 fw4 mb4 dib mr3">
              <a href="/blog/post/ffmpeg/" class="link black dim">
                Ffmpeg提取字幕文件
              </a>
            </h2>
          
            <h2 class="f5 fw4 mb4 dib mr3">
              <a href="/blog/post/mosdns/" class="link black dim">
                debian LXC搭建modsns
              </a>
            </h2>
          
            <h2 class="f5 fw4 mb4 dib mr3">
              <a href="/blog/post/ros_dhcp6/" class="link black dim">
                Ros通过dhcp6下发ipv6 dns的设定
              </a>
            </h2>
          
        </section>
      

    </div>
  

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://dsunn.github.io/blog/" >
    &copy;  Whatever blog 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
