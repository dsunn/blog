<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>cloudflare ddns的routeros脚本 | Whatever blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Article description.">
    <meta name="generator" content="Hugo 0.145.0">
    
    
    
      <meta name="robots" content="index, follow">
    
    

    
<link rel="stylesheet" href="/blog/ananke/css/main.min.d05fb5f317fcf33b3a52936399bdf6f47dc776516e1692e412ec7d76f4a5faa2.css" >




    

    
      

    

    

    
      <link rel="canonical" href="https://dsunn.github.io/blog/post/mikrotik_cf_ddns/">
    

    <meta property="og:url" content="https://dsunn.github.io/blog/post/mikrotik_cf_ddns/">
  <meta property="og:site_name" content="Whatever blog">
  <meta property="og:title" content="cloudflare ddns的routeros脚本">
  <meta property="og:description" content="Article description.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-03-05T07:33:25-05:00">
    <meta property="article:modified_time" content="2024-03-05T07:33:25-05:00">
    <meta property="article:tag" content="Ros">
    <meta property="article:tag" content="Ddns">
    <meta property="article:tag" content="Dns">
    <meta property="article:tag" content="Ipv6">

  <meta itemprop="name" content="cloudflare ddns的routeros脚本">
  <meta itemprop="description" content="Article description.">
  <meta itemprop="datePublished" content="2024-03-05T07:33:25-05:00">
  <meta itemprop="dateModified" content="2024-03-05T07:33:25-05:00">
  <meta itemprop="wordCount" content="192">
  <meta itemprop="keywords" content="Ros,Ddns,Dns,Ipv6">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="cloudflare ddns的routeros脚本">
  <meta name="twitter:description" content="Article description.">

      
    
	
  </head><body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/blog/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Whatever blog
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">cloudflare ddns的routeros脚本</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2024-03-05T07:33:25-05:00">March 5, 2024</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>在参考了j大佬的<a href="https://www.digs.eu.org/2024/01/04/ROS%20cloudflare%20DDNS%E7%9B%B8%E5%85%B3%E8%84%9A%E6%9C%AC/">博客</a>和这位作者的<a href="https://gist.githubusercontent.com/kolobus/18680f8fb01ce3003cb9a3f82c9d30e1/raw/cf8ecd84fc0e5dccb7298422c7d8c40410c345a3/cf-ddns.rsc">脚本</a>的脚本后, 魔改的.</p>
<p>适用在cloudflare上更新ipv4和ipv6的动态ip; 和原作者不同的是, 我的脚本是直接从ros接口上取相应ip, 其实我这脚本是放在ppp profile-on up-script中, 在拨号完成后执行一次, 而不是定时反复执行, 故相应修改了代码.</p>
<p>token, zone_id, record_id等请先行获取, 获取方法在前述j大佬博客中有所提及.</p>
<pre tabindex="0"><code># Cloudflare Dynamic DNS update script
# Required policy: read, write, test, policy
# Add this script to scheduler
# Install DigiCert root CA or disable check-certificate
# Modified from https://gist.github.com/kolobus/18680f8fb01ce3003cb9a3f82c9d30e1
# Configuration ---------------------------------------------------------------------

:local TOKEN &#34;&#34;

:local ZONEIDv6 &#34;&#34;
:local RECORDIDv6 &#34;&#34;
:local RECORDNAMEv6 &#34;&#34;
:local IP6NEW

:local ZONEIDv4 &#34;&#34;
:local RECORDIDv4 &#34;&#34;
:local RECORDNAMEv4 &#34;&#34;
:local IP4NEW

:local WANIF &#34;&#34;

#------------------------------------------------------------------------------------




:if ([/interface get $WANIF value-name=running]) do={

    # IPv6 check

    :local &#34;IP6NEW&#34; [/ipv6/address get [:pick [find dynamic global interface=$WANIF] 0 ] address]
    :set &#34;IP6NEW&#34; [:pick $&#34;IP6NEW&#34; 0 [:find $&#34;IP6NEW&#34; &#34;/&#34;]]

        :local url &#34;https://api.cloudflare.com/client/v4/zones/$ZONEIDv6/dns_records/$RECORDIDv6/&#34;

        :local cfapi [/tool fetch http-method=put mode=https url=$url check-certificate=no output=user as-value \
            http-header-field=&#34;Authorization: Bearer $TOKEN&#34; \
            http-data=&#34;{\&#34;type\&#34;:\&#34;AAAA\&#34;,\&#34;name\&#34;:\&#34;$RECORDNAMEv6\&#34;,\&#34;content\&#34;:\&#34;$IP6NEW\&#34;,\&#34;ttl\&#34;:120,\&#34;proxied\&#34;:false}&#34;]

        :log info &#34;CF-DDNS: $RECORDNAMEv6 is now $IP6NEW&#34;


   # IPv4 check

    :local ipaddr [/ip address get [/ip address find interface=$WANIF] address]
    :set IP4NEW [:pick $ipaddr 0 ([len $ipaddr] -3)]

        :local url &#34;https://api.cloudflare.com/client/v4/zones/$ZONEIDv4/dns_records/$RECORDIDv4/&#34;

        :local cfapi [/tool fetch http-method=put mode=https url=$url check-certificate=no output=user as-value \
            http-header-field=&#34;Authorization: Bearer $TOKEN&#34; \
            http-data=&#34;{\&#34;type\&#34;:\&#34;A\&#34;,\&#34;name\&#34;:\&#34;$RECORDNAMEv4\&#34;,\&#34;content\&#34;:\&#34;$IP4NEW\&#34;,\&#34;ttl\&#34;:120,\&#34;proxied\&#34;:false}&#34;]

        :log info &#34;CF-DDNS: $RECORDNAMEv4 is now $IP4NEW&#34;


} else={

    :log info &#34;CF-DDNS: $WANIF is not currently running, quitting&#34;

}
</code></pre><ul class="pa0">
  
   <li class="list di">
     <a href="/blog/tags/ros/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Ros</a>
   </li>
  
   <li class="list di">
     <a href="/blog/tags/ddns/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Ddns</a>
   </li>
  
   <li class="list di">
     <a href="/blog/tags/dns/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Dns</a>
   </li>
  
   <li class="list di">
     <a href="/blog/tags/ipv6/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Ipv6</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/post/ros_dhcp6/">Ros通过dhcp6下发ipv6 dns的设定</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/post/mosdns/">debian LXC搭建modsns</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://dsunn.github.io/blog/" >
    &copy;  Whatever blog 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
