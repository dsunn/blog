<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>debian LXC搭建modsns | Whatever blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Article description.">
    <meta name="generator" content="Hugo 0.145.0">
    
    
    
      <meta name="robots" content="index, follow">
    
    

    
<link rel="stylesheet" href="/blog/ananke/css/main.min.d05fb5f317fcf33b3a52936399bdf6f47dc776516e1692e412ec7d76f4a5faa2.css" >




    

    
      

    

    

    
      <link rel="canonical" href="https://dsunn.github.io/blog/post/mosdns/">
    

    <meta property="og:url" content="https://dsunn.github.io/blog/post/mosdns/">
  <meta property="og:site_name" content="Whatever blog">
  <meta property="og:title" content="debian LXC搭建modsns">
  <meta property="og:description" content="Article description.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2023-06-05T09:41:28-04:00">
    <meta property="article:modified_time" content="2023-06-05T09:41:28-04:00">
    <meta property="article:tag" content="Dns">

  <meta itemprop="name" content="debian LXC搭建modsns">
  <meta itemprop="description" content="Article description.">
  <meta itemprop="datePublished" content="2023-06-05T09:41:28-04:00">
  <meta itemprop="dateModified" content="2023-06-05T09:41:28-04:00">
  <meta itemprop="wordCount" content="317">
  <meta itemprop="keywords" content="Dns">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="debian LXC搭建modsns">
  <meta name="twitter:description" content="Article description.">

      
    
	
  </head><body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/blog/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Whatever blog
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">debian LXC搭建modsns</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2023-06-05T09:41:28-04:00">June 5, 2023</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>修改于6/5/2023</p>
<p>搭建环境: PVE LXC debian 11, 网关clash(科学环境)
项目地址: <a href="https://github.com/IrineSistiana/mosdns">https://github.com/IrineSistiana/mosdns</a></p>
<p>下载并copy 二进制文件mosdns到 /usr/bin/
新建目录: /etc/mosdns, 下载并copy一众规则文件到该目录, 配置文件config.yaml也放这里</p>
<p>关闭systemd-resolved</p>
<pre tabindex="0"><code>systemctl disable systemd-resolved
</code></pre><p>新建/etc/systemd/system/mosdns.service</p>
<pre tabindex="0"><code># /etc/systemd/system/mosdns.service
[Unit]
Description=A DNS forwarder
ConditionFileIsExecutable=/usr/bin/mosdns

[Service]
User=root
StartLimitInterval=5
StartLimitBurst=10
ExecStart=/usr/bin/mosdns &#34;start&#34; &#34;-c&#34; &#34;/etc/mosdns/config.yaml&#34; &#34;-d&#34; &#34;/etc/mosdns&#34;
Restart=always
RestartSec=120
EnvironmentFile=-/etc/sysconfig/mosdns

[Install]
WantedBy=multi-user.target
</code></pre><p>开机自启/启动运行</p>
<pre tabindex="0"><code>systemctl enable mosdns
systemctl start mosdns
</code></pre><p>我个人的配置文件如下(v5), (不使用fallback, 仅以direct文件分流):</p>
<pre tabindex="0"><code>## mosdns v5 conf


log:
  level: debug
  # file: &#34;/etc/mosdns/logs/mosdns.log&#34;
  # production: false


plugins:
  - tag: cache
    type: cache
    args:
      size: 409600
      lazy_cache_ttl: 259200
      dump_file: ./cache.dump
      dump_interval: 600


#规则txt文件 在https://github.com/Loyalsoldier/v2ray-rules-dat下载
  - tag: domain_cn
    type: domain_set
    args:
      exps:                         # 域名表达式。
        - &#39;xn--4gq62f52gdss.com&#39;
        - &#39;mycai.ml&#39;
        # - &#34;google.com&#34;
        # - &#34;regexp:.+\.google\.com$&#34;
      files:                          # 从文件载入
        - &#39;./direct-list.txt&#39;


  - tag: ads
    type: domain_set
    args:
      files:
        - &#39;./oisd_big_domains.txt&#39;   #basic 文件可能better
        - &#39;./reject-list.txt&#39;

  # 转发至本地服务器的插件
  - tag: forward_local
    type: forward
    args:
      concurrent: 1
      upstreams:
        - tag: ros_udp   #ros主路由dns(配置了ISP的v4/6dns和223,114)
          addr: 192.168.10.251
          dial_addr: 192.168.10.251

  # 转发至远程服务器的插件
  - tag: forward_remote
    type: forward
    args:
      concurrent: 1
      upstreams:
        - tag: google_dot
          # addr: &#34;https://dns.google/dns-query&#34;
          addr: &#34;tls://dns.google&#34;
          dial_addr: &#34;8.8.8.8&#34;
          bootstrap: &#34;8.8.8.8&#34;
          idle_timeout: 30
          enable_pipeline: false
          enable_http3: false
          max_conns: 2
          insecure_skip_verify: false
          so_mark: 0
          bind_to_device: &#34;&#34;
        - tag: cf_dot
          # addr: &#39;https://cloudflare-dns.com/dns-query&#39;
          addr: &#39;tls://1.1.1.1:853&#39;
          dial_addr: &#39;1.1.1.1&#39;
          bootstrap: &#34;1.1.1.1&#34;
          idle_timeout: 30
          enable_pipeline: false
          enable_http3: false
          max_conns: 2
          insecure_skip_verify: false
          so_mark: 0
          bind_to_device: &#34;&#34;



  - tag: main
    type: sequence
    args:
      # # ads blocked in adgh, so not here in mosdns
      # - matches:             # 如果
      #     - qname $ads # 如果请求的域名在广告列表内。
      #   exec: reject 3       # 执行 直接返回 NXDOMAIN(3) 屏蔽。
      - exec: $cache      # 然后。查找 cache。
      - matches:             # 如果
          - has_resp         # 有应答了(上一步 cache 找到应答)
        exec: accept         # 结束。
      # 上一步没有找到缓存，就会到这一步，转发至 local/remote 分流 获取应答。
      - matches: 
          - qname $domain_cn
        exec: $forward_local
      - matches: has_resp   #has_wanted_ans / has_resp
        exec: accept
      # - exec: prefer_ipv4
      - exec: $forward_remote
      - exec: accept


  # 启动 udp 和 tcp 服务器。
  - tag: udp_server
    type: udp_server
    args:
      entry: main # 收到的请求会执行上面的逻辑
      listen: :53
  - tag: tcp_server
    type: tcp_server
    args:
      entry: main
      listen: :53
</code></pre><ul class="pa0">
  
   <li class="list di">
     <a href="/blog/tags/dns/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Dns</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/post/ros_dhcp6/">Ros通过dhcp6下发ipv6 dns的设定</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://dsunn.github.io/blog/" >
    &copy;  Whatever blog 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
